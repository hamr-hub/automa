# LangGraph + Supabase 集成测试计划

## 1. 测试概述

### 1.1 测试目标

确保 LangGraph AI 工作流生成功能与 Supabase 后端服务的集成稳定性、数据一致性和安全性。

### 1.2 测试范围

- LangGraph 状态图执行流程
- Supabase API 接口交互
- 身份验证和权限控制
- 数据读写操作
- 实时同步功能
- **工作流块操作**
- **工作流执行和日志**
- **数据提取功能**
- **导入导出功能**
- **定时任务功能**

## 2. 测试环境配置

### 2.1 环境要求

- Node.js >= 20.11.1
- Playwright >= 1.57.0
- Supabase 测试项目
- Ollama 本地服务（用于 AI 生成）

### 2.2 测试数据准备

- 测试用户账户
- 示例工作流数据
- 模拟用户输入和预期输出

## 3. 测试用例设计

### 3.1 Supabase API 交互测试

#### TC-SUP-001: 客户端初始化

- **测试步骤**:
  1. 调用 SupabaseClient.initialize()
  2. 验证客户端状态
- **预期结果**: 客户端成功初始化，initialized = true
- **优先级**: P0

#### TC-SUP-002: 工作流 CRUD 操作

- **测试步骤**:
  1. 创建工作流
  2. 查询工作流
  3. 更新工作流
  4. 删除工作流
- **预期结果**: 所有操作成功，数据一致
- **优先级**: P0

#### TC-SUP-003: 批量操作

- **测试步骤**:
  1. 批量插入工作流
  2. 批量查询工作流
- **预期结果**: 批量操作正确执行
- **优先级**: P1

### 3.2 身份验证测试

#### TC-AUTH-001: 用户注册

- **测试步骤**:
  1. 调用 signUp() 注册新用户
  2. 验证用户创建
- **预期结果**: 用户成功创建，返回用户信息
- **优先级**: P0

#### TC-AUTH-002: 用户登录

- **测试步骤**:
  1. 调用 signInWithPassword()
  2. 获取会话信息
- **预期结果**: 登录成功，会话有效
- **优先级**: P0

#### TC-AUTH-003: 会话管理

- **测试步骤**:
  1. 获取会话
  2. 刷新会话
  3. 登出
- **预期结果**: 会话操作正常
- **优先级**: P1

### 3.3 LangGraph 执行测试

#### TC-LANG-001: 完整流程执行

- **测试步骤**:
  1. 输入用户请求
  2. 执行 LangGraph.run()
  3. 验证生成的 JSON
- **预期结果**: 生成有效的工作流 JSON
- **优先级**: P0

#### TC-LANG-002: 错误处理和重试

- **测试步骤**:
  1. 提供无效输入
  2. 验证重试机制
- **预期结果**: 错误被捕获，重试正常工作
- **优先级**: P1

#### TC-LANG-003: 节点状态传递

- **测试步骤**:
  1. 执行图执行
  2. 检查状态传递
- **预期结果**: 状态正确传递到下一节点
- **优先级**: P1

### 3.4 数据一致性测试

#### TC-DATA-001: 本地与远程同步

- **测试步骤**:
  1. 创建本地工作流
  2. 同步到 Supabase
  3. 验证数据一致性
- **预期结果**: 本地和远程数据一致
- **优先级**: P0

#### TC-DATA-002: 并发操作

- **测试步骤**:
  1. 并发创建工作流
  2. 检查数据完整性
- **预期结果**: 无数据冲突
- **优先级**: P1

### 3.5 权限控制测试

#### TC-PERM-001: 所有权验证

- **测试步骤**:
  1. 用户 A 创建工作流
  2. 用户 B 尝试访问
- **预期结果**: 用户 B 无法访问用户 A 的工作流
- **优先级**: P0

#### TC-PERM-002: 共享权限

- **测试步骤**:
  1. 分享工作流给用户 B
  2. 验证用户 B 的访问权限
- **预期结果**: 共享权限正确生效
- **优先级**: P1

## 4. 块操作测试 (新增)

### 4.1 块添加测试

#### TC-BLOCK-001: 添加新块

- **测试步骤**:
  1. 打开工作流编辑器
  2. 点击添加块按钮
  3. 选择块类型
- **预期结果**: 块成功添加到工作流
- **优先级**: P0

#### TC-BLOCK-002: 配置块属性

- **测试步骤**:
  1. 点击块打开配置面板
  2. 修改块属性
  3. 保存配置
- **预期结果**: 块属性正确保存
- **优先级**: P0

#### TC-BLOCK-003: 连接块

- **测试步骤**:
  1. 添加多个块
  2. 创建块之间的连接
- **预期结果**: 块之间正确连接
- **优先级**: P0

#### TC-BLOCK-004: 删除块

- **测试步骤**:
  1. 选择块
  2. 删除块
- **预期结果**: 块从工作流中移除
- **优先级**: P1

#### TC-BLOCK-005: 复制块

- **测试步骤**:
  1. 选择块
  2. 使用复制功能
- **预期结果**: 块被复制到剪贴板
- **优先级**: P1

## 5. 工作流执行测试 (新增)

### 5.1 执行测试

#### TC-EXEC-001: 运行工作流

- **测试步骤**:
  1. 创建简单工作流
  2. 点击运行按钮
- **预期结果**: 工作流正确执行
- **优先级**: P0

#### TC-EXEC-002: 查看执行日志

- **测试步骤**:
  1. 执行工作流
  2. 打开日志面板
- **预期结果**: 日志正确显示执行过程
- **优先级**: P0

#### TC-EXEC-003: 停止执行

- **测试步骤**:
  1. 启动工作流
  2. 点击停止按钮
- **预期结果**: 执行立即停止
- **优先级**: P1

#### TC-EXEC-004: 查看执行历史

- **测试步骤**:
  1. 打开执行历史页面
- **预期结果**: 显示所有执行记录
- **优先级**: P1

## 6. 数据提取测试 (新增)

### 6.1 提取功能测试

#### TC-EXTRACT-001: 创建提取工作流

- **测试步骤**:
  1. 创建包含提取块的工作流
  2. 配置提取规则
- **预期结果**: 提取块正确配置
- **优先级**: P0

#### TC-EXTRACT-002: 配置选择器

- **测试步骤**:
  1. 打开元素块配置
  2. 设置 CSS 选择器
- **预期结果**: 选择器正确保存
- **优先级**: P0

#### TC-EXTRACT-003: 导出数据

- **测试步骤**:
  1. 配置导出块
  2. 执行工作流
- **预期结果**: 数据正确导出
- **优先级**: P1

## 7. 导入导出测试 (新增)

### 7.1 导入导出测试

#### TC-IMPORT-001: 导出工作流

- **测试步骤**:
  1. 选择工作流
  2. 点击导出
- **预期结果**: 下载 JSON 文件
- **优先级**: P0

#### TC-IMPORT-002: 导入工作流

- **测试步骤**:
  1. 点击导入按钮
  2. 选择 JSON 文件
- **预期结果**: 工作流成功导入
- **优先级**: P0

#### TC-IMPORT-003: 导出图片

- **测试步骤**:
  1. 打开工作流编辑器
  2. 导出为图片
- **预期结果**: 下载图片文件
- **优先级**: P1

#### TC-IMPORT-004: 分享工作流

- **测试步骤**:
  1. 点击分享按钮
  2. 复制分享链接
- **预期结果**: 生成有效的分享链接
- **优先级**: P1

## 8. 定时任务测试 (新增)

### 8.1 定时功能测试

#### TC-SCHED-001: 配置定时触发

- **测试步骤**:
  1. 创建工作流
  2. 配置时间触发器
- **预期结果**: 定时设置正确保存
- **优先级**: P0

#### TC-SCHED-002: 配置 Cron 表达式

- **测试步骤**:
  1. 设置 Cron 表达式
  2. 验证表达式格式
- **预期结果**: Cron 表达式有效
- **优先级**: P0

#### TC-SCHED-003: 查看定时任务

- **测试步骤**:
  1. 打开定时任务页面
- **预期结果**: 显示所有定时任务
- **优先级**: P1

#### TC-SCHED-004: 启用/禁用定时任务

- **测试步骤**:
  1. 切换定时任务状态
- **预期结果**: 状态正确切换
- **优先级**: P1

## 9. 自动化测试实现

### 9.1 测试框架

- Playwright（端到端测试）
- Jest（单元测试）

### 9.2 测试配置

- 测试环境变量
- Supabase 测试项目配置
- 报告生成配置

### 9.3 测试文件结构

```
tests/
├── e2e/
│   ├── automa-app.spec.js          # 应用基础功能测试
│   ├── new-workflow.spec.js        # 新建工作流测试
│   ├── core-workflow.spec.js       # 核心工作流测试
│   ├── comprehensive-workflow.spec.js  # 综合工作流测试
│   ├── amazon-workflow.spec.js     # Amazon 工作流测试
│   ├── auth.spec.js                # 身份验证测试
│   ├── langgraph-supabase.spec.js  # LangGraph + Supabase 集成测试
│   ├── langgraph-supabase-integration.spec.js  # 综合集成测试
│   ├── multi-turn-dialogue.spec.js # 多轮对话测试
│   ├── supabase-migration.spec.js  # 数据库迁移测试
│   ├── blocks.spec.js              # 块操作测试 (新增)
│   ├── workflow-execution.spec.js  # 工作流执行测试 (新增)
│   ├── data-extraction.spec.js     # 数据提取测试 (新增)
│   ├── import-export.spec.js       # 导入导出测试 (新增)
│   └── scheduling.spec.js          # 定时任务测试 (新增)
├── unit/
│   └── LangGraphService.test.mjs
├── fixtures/
├── run-tests.js
├── TEST_PLAN.md
└── TEST_EXECUTION_REPORT.md
```

## 10. 验收标准

### 10.1 功能要求

- 所有 P0 测试用例通过率 100%
- 所有 P1 测试用例通过率 >= 95%

### 10.2 性能要求

- API 响应时间 < 3s
- 页面加载时间 < 5s

### 10.3 可靠性要求

- 错误处理覆盖所有异常情况
- 无数据丢失或损坏

## 11. 测试覆盖率目标

| 模块          | 目标覆盖率 | 当前覆盖率 |
| ------------- | ---------- | ---------- |
| 核心工作流    | 90%        | 85%        |
| LangGraph AI  | 85%        | 80%        |
| Supabase 集成 | 90%        | 85%        |
| 块操作        | 80%        | 0% (新增)  |
| 数据提取      | 75%        | 0% (新增)  |
| 导入导出      | 80%        | 0% (新增)  |
| 定时任务      | 75%        | 0% (新增)  |
